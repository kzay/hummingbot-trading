# ============================================
# Alertmanager Configuration
# ============================================
# Alert delivery path:
#   Prometheus → Alertmanager → alert-webhook-sink → Telegram push
#
# The webhook_sink (monitoring/alertmanager/webhook_sink.py) forwards
# critical and key warning alerts to Telegram directly.
# Set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID in env/.env.

global:
  resolve_timeout: 5m

route:
  group_by: ["alertname", "severity"]
  group_wait: 15s
  group_interval: 5m
  repeat_interval: 4h
  receiver: "default"

  routes:
    # Critical alerts — fast delivery, repeat every 30 min until resolved.
    - match:
        severity: critical
      receiver: "webhook"
      repeat_interval: 30m
      group_wait: 10s

    # Key warning alerts that indicate silent bot failure modes.
    - match_re:
        alertname: "DailyStateStale|BotFrozen|BotSoftPauseTooLong|OrderBookStale|WsReconnectSpike|ContainerRestartLoop|BotHardStopActive|KillSwitchTriggered"
      receiver: "webhook"
      repeat_interval: 15m
      group_wait: 10s

receivers:
  - name: "default"
    webhook_configs:
      - url: "http://alert-webhook-sink:19093/alert"
        send_resolved: true

  - name: "webhook"
    webhook_configs:
      - url: "http://alert-webhook-sink:19093/alert"
        send_resolved: true

inhibit_rules:
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "instance"]
