# ============================================
# Hummingbot Trading Infrastructure
# docker-compose.yml - Production Configuration
# ============================================
# Usage:
#   cp ../env/.env.template ../env/.env  # then edit with real values
#   docker compose --env-file ../env/.env -f docker-compose.yml up -d
# ============================================

name: hbot

# ---- Networks ----
networks:
  trading:
    driver: bridge
    name: hbot-trading
  monitoring:
    driver: bridge
    name: hbot-monitoring

# ---- Volumes ----
volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  loki-data:
    driver: local
  postgres-data:
    driver: local

# ---- Logging anchor ----
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "${LOG_MAX_SIZE:-50m}"
    max-file: "${LOG_MAX_FILE:-5}"

# ---- External control-plane image (reproducible) ----
x-control-plane-image: &control-plane-image
  image: ${HBOT_CONTROL_PLANE_IMAGE:-hbot-control-plane:20260222}
  build:
    context: ..
    dockerfile: compose/images/control_plane/Dockerfile

# ---- Shared Hummingbot env ----
x-hbot-env: &hbot-env
  TZ: ${TZ:-UTC}
  PYTHONPYCACHEPREFIX: /tmp/pycache
  EXT_SIGNAL_RISK_ENABLED: ${EXT_SIGNAL_RISK_ENABLED:-true}
  BUS_SOFT_PAUSE_ON_OUTAGE: ${BUS_SOFT_PAUSE_ON_OUTAGE:-true}
  REDIS_HOST: ${REDIS_HOST:-redis}
  REDIS_PORT: ${REDIS_PORT:-6379}
  REDIS_DB: ${REDIS_DB:-0}
  REDIS_PASSWORD: ${REDIS_PASSWORD:-}
  REDIS_CONSUMER_GROUP: ${REDIS_CONSUMER_GROUP:-hb_group_v1}
  EVENT_POLL_MS: ${EVENT_POLL_MS:-1000}

# ---- Hummingbot base anchor ----
x-hbot-base: &hbot-base
  image: ${HUMMINGBOT_IMAGE:-hummingbot/hummingbot:version-2.12.0}
  restart: unless-stopped
  logging: *default-logging
  labels:
    - "autoheal=true"
  networks:
    - trading
  environment: *hbot-env
  stdin_open: true
  tty: true

# ============================================
# Services
# ============================================
services:
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: hbot-autoheal
    profiles:
      - external
      - monitoring
    restart: unless-stopped
    logging: *default-logging
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=180
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - trading
      - monitoring

  # ==========================================
  # BOT 1
  # ==========================================
  bot1:
    <<: *hbot-base
    container_name: hbot-bot1
    volumes:
      # ---- Bot config, data, logs ----
      - ../data/bot1/conf:/home/hummingbot/conf
      - ../data/bot1/logs:/home/hummingbot/logs
      - ../data/bot1/data:/home/hummingbot/data
      - ../data/bot1/scripts:/home/hummingbot/custom_scripts
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/scripts/v2_with_controllers.py:ro
      - ../scripts/shared/headless_start.py:/home/hummingbot/bin/headless_start.py:ro
      - ../data/bot1/pmm_scripts:/home/hummingbot/pmm_scripts
      # ---- Shared controllers mount (Day 30) ----
      - ../controllers:/home/hummingbot/controllers:ro
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
    command: /bin/bash -lc "conda activate hummingbot && python ./bin/headless_start.py 2>> ./logs/errors.log"
    environment:
      <<: *hbot-env
      EXT_SIGNAL_RISK_ENABLED: "true"
      CONFIG_PASSWORD: ${BOT1_PASSWORD:-}
      CONFIG_FILE_NAME: v2_with_controllers.py
      SCRIPT_CONFIG: v2_epp_v2_4_bot_a.yml
      BOT_MODE: ${BOT1_MODE:-paper}
      HEADLESS_MODE: "true"
      BOT_POLICY_ROLE: live_microcap_primary
      BOT_POLICY_MODE: live
      BOT_POLICY_VERSION: multi_bot_policy_v1
    healthcheck:
      # Restart if minute.csv hasn't been written for >5 min (WS event-loop hang detector).
      test:
        [
          "CMD-SHELL",
          "python -c \"import sys,time; from pathlib import Path; files=list(Path('/home/hummingbot/logs/epp_v24').rglob('minute.csv')); newest=max((f.stat().st_mtime for f in files), default=0); hb=Path('/home/hummingbot/logs/heartbeat/strategy_heartbeat.json'); hb_ok=hb.exists() and (time.time()-hb.stat().st_mtime)<300; minute_ok=bool(files) and (time.time()-newest)<300; sys.exit(0 if minute_ok and hb_ok else 1)\""
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ==========================================
  # BOT 2 (scale replica)
  # ==========================================
  bot2:
    <<: *hbot-base
    container_name: hbot-bot2
    profiles:
      - multi
    volumes:
      # ---- Bot config, data, logs ----
      - ../data/bot2/conf:/home/hummingbot/conf
      - ../data/bot2/logs:/home/hummingbot/logs
      - ../data/bot2/data:/home/hummingbot/data
      - ../data/bot2/scripts:/home/hummingbot/custom_scripts
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/custom_scripts/v2_with_controllers.py:ro
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/scripts/v2_with_controllers.py:ro
      - ../data/bot2/pmm_scripts:/home/hummingbot/pmm_scripts
      # ---- Shared controllers mount (Day 30) ----
      - ../controllers:/home/hummingbot/controllers:ro
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
    environment:
      <<: *hbot-env
      CONFIG_PASSWORD: ${BOT2_PASSWORD:-admin}
      BOT_POLICY_ROLE: reserved_scale_slot
      BOT_POLICY_MODE: disabled
      BOT_POLICY_VERSION: multi_bot_policy_v1
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ==========================================
  # BOT 3 (paper trading smoke test)
  # ==========================================
  bot3:
    <<: *hbot-base
    container_name: hbot-bot3
    profiles:
      - test
    volumes:
      - ../data/bot3/conf:/home/hummingbot/conf
      - ../data/bot3/logs:/home/hummingbot/logs
      - ../data/bot3/data:/home/hummingbot/data
      - ../data/bot3/scripts:/home/hummingbot/custom_scripts
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/custom_scripts/v2_with_controllers.py:ro
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/scripts/v2_with_controllers.py:ro
      - ../data/bot3/pmm_scripts:/home/hummingbot/pmm_scripts
      # ---- Shared controllers mount (Day 30) ----
      - ../controllers:/home/hummingbot/controllers
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
      # Mount test script into the scripts dir so `start --script` finds it
      - ../data/bot3/scripts/paper_test.py:/home/hummingbot/scripts/paper_test.py:ro
    environment:
      <<: *hbot-env
      CONFIG_PASSWORD: ${BOT3_PASSWORD:-${BOT1_PASSWORD:-}}
      BOT_POLICY_ROLE: paper_validation
      BOT_POLICY_MODE: paper_only
      BOT_POLICY_VERSION: multi_bot_policy_v1
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"

  # ==========================================
  # BOT 4 (binance testnet v2 matrix)
  # ==========================================
  bot4:
    <<: *hbot-base
    container_name: hbot-bot4
    profiles:
      - test
    volumes:
      - ../data/bot4/conf:/home/hummingbot/conf
      - ../data/bot4/logs:/home/hummingbot/logs
      - ../data/bot4/data:/home/hummingbot/data
      - ../data/bot4/scripts:/home/hummingbot/custom_scripts
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/scripts/v2_with_controllers.py:ro
      - ../data/bot4/conf/bot4_matrix_results.md:/home/hummingbot/conf/bot4_matrix_results.md
      - ../data/bot4/pmm_scripts:/home/hummingbot/pmm_scripts
      - ../scripts/shared/v2_with_controllers.py:/home/hummingbot/custom_scripts/v2_with_controllers.py:ro
      # ---- Shared controllers mount (Day 30) ----
      - ../controllers:/home/hummingbot/controllers:ro
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
    environment:
      <<: *hbot-env
      CONFIG_PASSWORD: ${BOT4_PASSWORD:-${BOT1_PASSWORD:-}}
      BOT_POLICY_ROLE: connector_validation
      BOT_POLICY_MODE: testnet_probe
      BOT_POLICY_VERSION: multi_bot_policy_v1
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"

  # ==========================================
  # External Signal/Risk Stack
  # ==========================================
  redis:
    image: redis:7.2-alpine
    container_name: hbot-redis
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${REDIS_BIND_IP:-127.0.0.1}:${REDIS_PORT:-6379}:6379"
    networks:
      - trading
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: hbot-mosquitto
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "${MQTT_BIND_IP:-127.0.0.1}:${MQTT_PORT:-1883}:1883"
    networks:
      - trading
    volumes:
      - ../config/mosquitto:/mosquitto/config:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mosquitto_sub -t '$$SYS/broker/uptime' -C 1 -W 3 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  signal-service:
    <<: *control-plane-image
    container_name: hbot-signal-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/signal_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - ML_ENABLED=${ML_ENABLED:-false}
      - ML_RUNTIME=${ML_RUNTIME:-sklearn_joblib}
      - ML_MODEL_SOURCE=${ML_MODEL_SOURCE:-local}
      - ML_MODEL_URI=${ML_MODEL_URI:-/workspace/hbot/models/current/model.joblib}
      - ML_MODEL_REFRESH_SEC=${ML_MODEL_REFRESH_SEC:-300}
      - ML_CONFIDENCE_MIN=${ML_CONFIDENCE_MIN:-0.60}
      - ML_MAX_SIGNAL_AGE_MS=${ML_MAX_SIGNAL_AGE_MS:-3000}
      - ML_INFERENCE_TIMEOUT_MS=${ML_INFERENCE_TIMEOUT_MS:-200}
      - ML_HORIZON_S=${ML_HORIZON_S:-60}
      - ML_FEATURE_SET=${ML_FEATURE_SET:-v1}
      - ML_CUSTOM_CLASS_PATH=${ML_CUSTOM_CLASS_PATH:-}
      - ML_S3_HTTP_TIMEOUT_SEC=${ML_S3_HTTP_TIMEOUT_SEC:-10}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=signal_service
    volumes:
      - ..:/workspace/hbot:ro
      - ../models:/workspace/hbot/models:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,redis,sys; c=redis.Redis(host=os.getenv(''REDIS_HOST'',''redis''),port=int(os.getenv(''REDIS_PORT'',''6379'')),db=int(os.getenv(''REDIS_DB'',''0'')),password=os.getenv(''REDIS_PASSWORD'') or None,socket_timeout=2); sys.exit(0 if c.ping() else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  risk-service:
    <<: *control-plane-image
    container_name: hbot-risk-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/risk_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - RISK_MAX_ABS_SIGNAL=${RISK_MAX_ABS_SIGNAL:-0.25}
      - ML_ENABLED=${ML_ENABLED:-false}
      - ML_CONFIDENCE_MIN=${ML_CONFIDENCE_MIN:-0.60}
      - ML_MAX_SIGNAL_AGE_MS=${ML_MAX_SIGNAL_AGE_MS:-3000}
      - RISK_MAX_ABS_PREDICTED_RETURN=${RISK_MAX_ABS_PREDICTED_RETURN:-0.05}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=risk_service
    volumes:
      - ..:/workspace/hbot:ro
      - ../reports:/workspace/hbot/reports
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,redis,sys; c=redis.Redis(host=os.getenv(''REDIS_HOST'',''redis''),port=int(os.getenv(''REDIS_PORT'',''6379'')),db=int(os.getenv(''REDIS_DB'',''0'')),password=os.getenv(''REDIS_PASSWORD'') or None,socket_timeout=2); sys.exit(0 if c.ping() else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  coordination-service:
    <<: *control-plane-image
    container_name: hbot-coordination-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/coordination_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - ML_ENABLED=${ML_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - COORD_POLICY_PATH=/workspace/hbot/config/coordination_policy_v1.json
      - COORD_ENABLED=${COORD_ENABLED:-false}
      - COORD_REQUIRE_ML_ENABLED=${COORD_REQUIRE_ML_ENABLED:-true}
      - COORD_HEALTH_PATH=/workspace/hbot/reports/coordination/latest.json
      - COORD_HEALTH_WRITE_SEC=${COORD_HEALTH_WRITE_SEC:-5}
      - COORD_HEALTH_MAX_SEC=${COORD_HEALTH_MAX_SEC:-600}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=coordination_service
    volumes:
      - ..:/workspace/hbot:ro
      - ../reports:/workspace/hbot/reports
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(os.getenv(''COORD_HEALTH_PATH'',''/workspace/hbot/reports/coordination/latest.json'')); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''COORD_HEALTH_MAX_SEC'',''600'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  event-store-service:
    <<: *control-plane-image
    container_name: hbot-event-store-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/event_store/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_STORE_CONSUMER_GROUP=${EVENT_STORE_CONSUMER_GROUP:-hb_event_store_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - EVENT_STORE_HEALTH_MAX_SEC=${EVENT_STORE_HEALTH_MAX_SEC:-900}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=event_store_service
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/event_store''); fs=sorted(p.glob(''integrity_*.json'')); sys.exit(0 if fs and (time.time()-fs[-1].stat().st_mtime)<=float(os.getenv(''EVENT_STORE_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  event-store-monitor:
    <<: *control-plane-image
    container_name: hbot-event-store-monitor
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/scripts/utils/event_store_periodic_snapshot.py --interval-sec ${EVENT_STORE_MONITOR_INTERVAL_SEC:-900}"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - EVENT_STORE_MONITOR_INTERVAL_SEC=${EVENT_STORE_MONITOR_INTERVAL_SEC:-900}
      - EVENT_STORE_MONITOR_HEALTH_MAX_SEC=${EVENT_STORE_MONITOR_HEALTH_MAX_SEC:-1800}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
      event-store-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/event_store''); fs=sorted(p.glob(''integrity_*.json'')); sys.exit(0 if fs and (time.time()-fs[-1].stat().st_mtime)<=float(os.getenv(''EVENT_STORE_MONITOR_HEALTH_MAX_SEC'',''1800'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  day2-gate-monitor:
    <<: *control-plane-image
    container_name: hbot-day2-gate-monitor
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/scripts/utils/day2_gate_monitor.py --interval-sec ${DAY2_GATE_INTERVAL_SEC:-300}"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - DAY2_GATE_INTERVAL_SEC=${DAY2_GATE_INTERVAL_SEC:-300}
      - DAY2_GATE_MIN_HOURS=${DAY2_GATE_MIN_HOURS:-9}
      - DAY2_GATE_MAX_DELTA=${DAY2_GATE_MAX_DELTA:-5}
      - DAY2_GATE_HEALTH_MAX_SEC=${DAY2_GATE_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
      event-store-service:
        condition: service_started
      event-store-monitor:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/event_store/day2_gate_eval_latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''DAY2_GATE_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  reconciliation-service:
    <<: *control-plane-image
    container_name: hbot-reconciliation-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/reconciliation_service/main.py"
    environment:
      - HB_DATA_ROOT=/workspace/hbot/data
      - RECON_INTERVAL_SEC=${RECON_INTERVAL_SEC:-300}
      - RECON_INVENTORY_DRIFT_WARN=${RECON_INVENTORY_DRIFT_WARN:-0.25}
      - RECON_INVENTORY_DRIFT_CRITICAL=${RECON_INVENTORY_DRIFT_CRITICAL:-0.45}
      - RECON_ALERT_WEBHOOK_URL=${RECON_ALERT_WEBHOOK_URL:-http://alert-webhook-sink:19093/alert}
      - RECON_ALERT_MIN_SEVERITY=${RECON_ALERT_MIN_SEVERITY:-critical}
      - RECON_EXCHANGE_SOURCE_ENABLED=${RECON_EXCHANGE_SOURCE_ENABLED:-true}
      - RECON_EXCHANGE_SNAPSHOT_PATH=${RECON_EXCHANGE_SNAPSHOT_PATH:-/workspace/hbot/reports/exchange_snapshots/latest.json}
      - RECON_THRESHOLDS_PATH=${RECON_THRESHOLDS_PATH:-/workspace/hbot/config/reconciliation_thresholds.json}
      - RECON_HEALTH_MAX_SEC=${RECON_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      event-store-service:
        condition: service_started
      exchange-snapshot-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/reconciliation/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''RECON_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  exchange-snapshot-service:
    <<: *control-plane-image
    container_name: hbot-exchange-snapshot-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/exchange_snapshot_service/main.py"
    environment:
      - HB_DATA_ROOT=/workspace/hbot/data
      - EXCHANGE_SNAPSHOT_OUT_PATH=/workspace/hbot/reports/exchange_snapshots/latest.json
      - EXCHANGE_SNAPSHOT_INTERVAL_SEC=${EXCHANGE_SNAPSHOT_INTERVAL_SEC:-120}
      - EXCHANGE_SNAPSHOT_MODE=${EXCHANGE_SNAPSHOT_MODE:-bitget_ccxt_private}
      - EXCHANGE_SNAPSHOT_ASSETS=${EXCHANGE_SNAPSHOT_ASSETS:-BTC,USDT}
      - EXCHANGE_ACCOUNT_MAP_PATH=${EXCHANGE_ACCOUNT_MAP_PATH:-/workspace/hbot/config/exchange_account_map.json}
      - BITGET_API_KEY=${BOT1_BITGET_API_KEY:-}
      - BITGET_SECRET=${BOT1_BITGET_API_SECRET:-}
      - BITGET_PASSPHRASE=${BOT1_BITGET_PASSPHRASE:-}
      - BOT2_BITGET_API_KEY=${BOT2_BITGET_API_KEY:-}
      - BOT2_BITGET_SECRET=${BOT2_BITGET_API_SECRET:-}
      - BOT2_BITGET_PASSPHRASE=${BOT2_BITGET_PASSPHRASE:-}
      - BOT3_BITGET_API_KEY=${BOT3_BITGET_API_KEY:-}
      - BOT3_BITGET_SECRET=${BOT3_BITGET_API_SECRET:-}
      - BOT3_BITGET_PASSPHRASE=${BOT3_BITGET_PASSPHRASE:-}
      - EXCHANGE_SNAPSHOT_HEALTH_MAX_SEC=${EXCHANGE_SNAPSHOT_HEALTH_MAX_SEC:-600}
    volumes:
      - ..:/workspace/hbot
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/exchange_snapshots/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''EXCHANGE_SNAPSHOT_HEALTH_MAX_SEC'',''600'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  shadow-parity-service:
    <<: *control-plane-image
    container_name: hbot-shadow-parity-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/shadow_execution/main.py"
    environment:
      - HB_DATA_ROOT=/workspace/hbot/data
      - PARITY_INTERVAL_SEC=${PARITY_INTERVAL_SEC:-300}
      - PARITY_THRESHOLDS_PATH=${PARITY_THRESHOLDS_PATH:-/workspace/hbot/config/parity_thresholds.json}
      - PARITY_RECONCILIATION_PATH=${PARITY_RECONCILIATION_PATH:-/workspace/hbot/reports/reconciliation/latest.json}
      - PARITY_HEALTH_MAX_SEC=${PARITY_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      event-store-service:
        condition: service_started
      reconciliation-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/parity/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''PARITY_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  portfolio-risk-service:
    <<: *control-plane-image
    container_name: hbot-portfolio-risk-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/portfolio_risk_service/main.py"
    environment:
      - HB_DATA_ROOT=/workspace/hbot/data
      - PORTFOLIO_RISK_INTERVAL_SEC=${PORTFOLIO_RISK_INTERVAL_SEC:-300}
      - PORTFOLIO_RISK_LIMITS_PATH=${PORTFOLIO_RISK_LIMITS_PATH:-/workspace/hbot/config/portfolio_limits_v1.json}
      - PORTFOLIO_RISK_PUBLISH_ACTIONS=${PORTFOLIO_RISK_PUBLISH_ACTIONS:-true}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - PORTFOLIO_RISK_HEALTH_MAX_SEC=${PORTFOLIO_RISK_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
      event-store-service:
        condition: service_started
      reconciliation-service:
        condition: service_started
      shadow-parity-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/portfolio_risk/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''PORTFOLIO_RISK_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  portfolio-allocator-service:
    <<: *control-plane-image
    container_name: hbot-portfolio-allocator-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/portfolio_allocator/main.py"
    environment:
      - MULTI_BOT_POLICY_PATH=${MULTI_BOT_POLICY_PATH:-/workspace/hbot/config/multi_bot_policy_v1.json}
      - EXCHANGE_SNAPSHOT_PATH=${EXCHANGE_SNAPSHOT_PATH:-/workspace/hbot/reports/exchange_snapshots/latest.json}
      - PORTFOLIO_ALLOCATOR_REPORT_PATH=${PORTFOLIO_ALLOCATOR_REPORT_PATH:-/workspace/hbot/reports/policy/portfolio_allocator_latest.json}
      - PORTFOLIO_ALLOCATOR_INTERVAL_SEC=${PORTFOLIO_ALLOCATOR_INTERVAL_SEC:-300}
      - PORTFOLIO_ALLOCATOR_PUBLISH_INTENTS=${PORTFOLIO_ALLOCATOR_PUBLISH_INTENTS:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - PORTFOLIO_ALLOCATOR_HEALTH_MAX_SEC=${PORTFOLIO_ALLOCATOR_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
      exchange-snapshot-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/policy/portfolio_allocator_latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''PORTFOLIO_ALLOCATOR_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  soak-monitor:
    <<: *control-plane-image
    container_name: hbot-soak-monitor
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/scripts/release/soak_monitor.py --interval-sec ${SOAK_MONITOR_INTERVAL_SEC:-300} --freshness-max-min ${SOAK_MONITOR_FRESHNESS_MAX_MIN:-30}"
    environment:
      - SOAK_MONITOR_INTERVAL_SEC=${SOAK_MONITOR_INTERVAL_SEC:-300}
      - SOAK_MONITOR_FRESHNESS_MAX_MIN=${SOAK_MONITOR_FRESHNESS_MAX_MIN:-30}
      - SOAK_MONITOR_HEALTH_MAX_SEC=${SOAK_MONITOR_HEALTH_MAX_SEC:-1200}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      day2-gate-monitor:
        condition: service_started
      reconciliation-service:
        condition: service_started
      shadow-parity-service:
        condition: service_started
      portfolio-risk-service:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/soak/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''SOAK_MONITOR_HEALTH_MAX_SEC'',''1200'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  daily-ops-reporter:
    <<: *control-plane-image
    container_name: hbot-daily-ops-reporter
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/scripts/release/watch_daily_ops_report.py --interval-sec ${DAILY_OPS_REPORT_INTERVAL_SEC:-900}"
    environment:
      - DAILY_OPS_REPORT_INTERVAL_SEC=${DAILY_OPS_REPORT_INTERVAL_SEC:-900}
      - DAILY_OPS_REPORT_HEALTH_MAX_SEC=${DAILY_OPS_REPORT_HEALTH_MAX_SEC:-3600}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      soak-monitor:
        condition: service_started
      day2-gate-monitor:
        condition: service_started
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/docs/ops''); fs=sorted(p.glob(''daily_ops_report_*.md'')); sys.exit(0 if fs and (time.time()-fs[-1].stat().st_mtime)<=float(os.getenv(''DAILY_OPS_REPORT_HEALTH_MAX_SEC'',''3600'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  telegram-bot:
    <<: *control-plane-image
    container_name: hbot-telegram-bot
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/telegram_bot/main.py"
    environment:
      - PYTHONPATH=/workspace/hbot
      - PYTHONPYCACHEPREFIX=/tmp/pycache
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - HB_DATA_ROOT=/workspace/hbot/data
    volumes:
      - ..:/workspace/hbot:ro
    networks:
      - trading
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  kill-switch:
    <<: *control-plane-image
    container_name: hbot-kill-switch
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/kill_switch/main.py"
    ports:
      - "${KILL_SWITCH_HTTP_PORT:-9900}:9900"
    environment:
      - KILL_SWITCH_DRY_RUN=${KILL_SWITCH_DRY_RUN:-true}
      - KILL_SWITCH_EXCHANGE=${KILL_SWITCH_EXCHANGE:-bitget}
      - KILL_SWITCH_API_KEY=${KILL_SWITCH_API_KEY:-}
      - KILL_SWITCH_SECRET=${KILL_SWITCH_SECRET:-}
      - KILL_SWITCH_PASSPHRASE=${KILL_SWITCH_PASSPHRASE:-}
      - KILL_SWITCH_HTTP_PORT=9900
      - EXT_SIGNAL_RISK_ENABLED=true
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=kill_switch
    volumes:
      - ..:/workspace/hbot
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:9900/health'')" 2>/dev/null || exit 1',
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  ops-db-writer:
    <<: *control-plane-image
    container_name: hbot-ops-db-writer
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/ops_db_writer/main.py"
    environment:
      - HB_DATA_ROOT=/workspace/hbot/data
      - HB_REPORTS_ROOT=/workspace/hbot/reports
      - OPS_DB_HOST=${OPS_DB_HOST:-postgres}
      - OPS_DB_PORT=${OPS_DB_PORT:-5432}
      - OPS_DB_NAME=${OPS_DB_NAME:-hbot_ops}
      - OPS_DB_USER=${OPS_DB_USER:-hbot}
      - OPS_DB_PASSWORD=${OPS_DB_PASSWORD:-hbot_dev_password}
      - OPS_DB_WRITER_INTERVAL_SEC=${OPS_DB_WRITER_INTERVAL_SEC:-300}
      - OPS_DB_WRITER_HEALTH_MAX_SEC=${OPS_DB_WRITER_HEALTH_MAX_SEC:-900}
    volumes:
      - ..:/workspace/hbot
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - trading
      - monitoring
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import os,time,sys; from pathlib import Path; p=Path(''/workspace/hbot/reports/ops_db_writer/latest.json''); sys.exit(0 if p.exists() and (time.time()-p.stat().st_mtime)<=float(os.getenv(''OPS_DB_WRITER_HEALTH_MAX_SEC'',''900'')) else 1)"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Monitoring Stack
  # ==========================================

  # ---- Bot KPI Exporter ----
  bot-metrics-exporter:
    image: python:3.11-slim
    container_name: hbot-bot-metrics-exporter
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/monitoring/bot_metrics_exporter.py"
    environment:
      - PYTHONPATH=/workspace/hbot
      - PYTHONPYCACHEPREFIX=/tmp/pycache
      - HB_DATA_ROOT=/workspace/hbot/data
      - METRICS_PORT=9400
      - METRICS_PATH=/metrics
      - EXPORTER_LOG_TAIL_LINES=200
    volumes:
      - ..:/workspace/hbot:ro
    networks:
      - monitoring
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9400/metrics')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ---- Control-plane KPI Exporter ----
  control-plane-metrics-exporter:
    <<: *control-plane-image
    container_name: hbot-control-plane-metrics-exporter
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/control_plane_metrics_exporter.py"
    environment:
      - HB_REPORTS_ROOT=/workspace/hbot/reports
      - HB_DATA_ROOT=/workspace/hbot/data
      - CONTROL_PLANE_METRICS_PORT=9401
      - CONTROL_PLANE_METRICS_PATH=/metrics
      - CONTROL_PLANE_FRESHNESS_MAX_SEC=${CONTROL_PLANE_FRESHNESS_MAX_SEC:-1800}
    volumes:
      - ..:/workspace/hbot:ro
    networks:
      - monitoring
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9401/metrics')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ---- PostgreSQL Operational Store (Day 25) ----
  postgres:
    image: postgres:16-alpine
    container_name: hbot-postgres
    restart: unless-stopped
    logging: *default-logging
    environment:
      - POSTGRES_DB=${OPS_DB_NAME:-hbot_ops}
      - POSTGRES_USER=${OPS_DB_USER:-hbot}
      - POSTGRES_PASSWORD=${OPS_DB_PASSWORD:-hbot_dev_password}
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "${OPS_DB_BIND_IP:-127.0.0.1}:${OPS_DB_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - monitoring
      - trading
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${OPS_DB_USER:-hbot} -d ${OPS_DB_NAME:-hbot_ops}",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ---- Optional pgAdmin for local ops DB management ----
  pgadmin:
    image: dpage/pgadmin4:8.14
    container_name: hbot-pgadmin
    profiles:
      - ops-tools
    restart: unless-stopped
    logging: *default-logging
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-ops@example.local}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "${OPS_PGADMIN_BIND_IP:-127.0.0.1}:${OPS_PGADMIN_PORT:-5050}:80"
    networks:
      - monitoring
    depends_on:
      postgres:
        condition: service_healthy

  # ---- Prometheus ----
  prometheus:
    image: prom/prometheus:v2.51.2
    container_name: hbot-prometheus
    restart: unless-stopped
    logging: *default-logging
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}"
      - "--storage.tsdb.retention.size=${PROMETHEUS_RETENTION_SIZE:-5GB}"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    volumes:
      - ../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../monitoring/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - ../monitoring/prometheus/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9090:9090"
    networks:
      - monitoring
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:9090/-/healthy",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ---- Grafana ----
  grafana:
    image: grafana/grafana:10.4.2
    container_name: hbot-grafana
    restart: unless-stopped
    logging: *default-logging
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL:-http://localhost:3000}
      - GF_SERVER_SERVE_FROM_SUB_PATH=${GF_SERVER_SERVE_FROM_SUB_PATH:-false}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_LOG_LEVEL=warn
      - GF_INSTALL_PLUGINS=${GF_INSTALL_PLUGINS:-grafana-clock-panel}
      - OPS_DB_HOST=${OPS_DB_HOST:-postgres}
      - OPS_DB_PORT=${OPS_DB_PORT:-5432}
      - OPS_DB_NAME=${OPS_DB_NAME:-hbot_ops}
      - OPS_DB_USER=${OPS_DB_USER:-hbot}
      - OPS_DB_PASSWORD=${OPS_DB_PASSWORD:-hbot_dev_password}
    volumes:
      - grafana-data:/var/lib/grafana
      - ../monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:3000:3000"
    networks:
      - monitoring
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ---- Node Exporter ----
  node-exporter:
    image: prom/node-exporter:v1.8.1
    container_name: hbot-node-exporter
    restart: unless-stopped
    logging: *default-logging
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/host/root"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9100:9100"
    networks:
      - monitoring
    pid: host
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:9100/metrics",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ---- cAdvisor ----
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: hbot-cadvisor
    restart: unless-stopped
    logging: *default-logging
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:8080:8080"
    networks:
      - monitoring
    privileged: true
    devices:
      - /dev/kmsg:/dev/kmsg
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/healthz",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ---- Loki ----
  loki:
    image: grafana/loki:2.9.8
    container_name: hbot-loki
    restart: unless-stopped
    logging: *default-logging
    command: ["-config.file=/etc/loki/loki-config.yml"]
    volumes:
      - ../monitoring/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki-data:/loki
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:3100:3100"
    networks:
      - monitoring
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3100/ready",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  # ---- Promtail ----
  promtail:
    image: grafana/promtail:2.9.8
    container_name: hbot-promtail
    restart: unless-stopped
    logging: *default-logging
    command: ["-config.file=/etc/promtail/promtail-config.yml"]
    volumes:
      - ../monitoring/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - ../data:/workspace/hbot/data:ro
    networks:
      - monitoring
    depends_on:
      loki:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  # ---- Alertmanager (optional, activate with profile) ----
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: hbot-alertmanager
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - alerts
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
      - "--config.expand-env=true"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-0}
    volumes:
      - ../monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9093:9093"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"

  # ---- Local webhook sink for alert delivery tests ----
  alert-webhook-sink:
    image: python:3.11-slim
    container_name: hbot-alert-webhook-sink
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - alerts
    command: ["python", "/opt/webhook_sink.py"]
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    volumes:
      - ../monitoring/alertmanager/webhook_sink.py:/opt/webhook_sink.py:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:19093:19093"
    networks:
      - monitoring
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:19093/healthz')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"

  # ==========================================
  # DESK SNAPSHOT SERVICE (INFRA-5)
  # Canonical read model: materializes one JSON
  # snapshot per bot from minute.csv, fills.csv,
  # open_orders, daily_state, and gate reports.
  # Telegram bot and Grafana exporter read from here.
  # ==========================================
  desk-snapshot-service:
    <<: *control-plane-image
    container_name: hbot-desk-snapshot
    restart: unless-stopped
    volumes:
      - ..:/workspace/hbot:ro
      - ../reports:/workspace/hbot/reports
    command: /bin/bash -lc "python /workspace/hbot/services/desk_snapshot_service/main.py"
    environment:
      - PYTHONPATH=/workspace/hbot
      - PYTHONPYCACHEPREFIX=/tmp/pycache
      - HB_DATA_ROOT=/workspace/hbot/data
      - HB_REPORTS_ROOT=/workspace/hbot/reports
      - SNAPSHOT_POLL_INTERVAL_S=30
    networks:
      - trading
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.05"

  # ==========================================
  # BOT WATCHDOG â€” monitors minute.csv freshness,
  # auto-restarts frozen bots with circuit breaker
  # and Telegram alerts. Replaces the shell watchdog.
  # ==========================================
  bot-watchdog:
    <<: *control-plane-image
    container_name: hbot-bot-watchdog
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ..:/workspace/hbot:ro
    command: /bin/bash -lc "python /workspace/hbot/services/bot_watchdog/main.py"
    environment:
      - PYTHONPATH=/workspace/hbot
      - PYTHONPYCACHEPREFIX=/tmp/pycache
      - HB_DATA_ROOT=/workspace/hbot/data
      - WATCHDOG_BOTS=bot1
      - WATCHDOG_STALE_THRESHOLD_S=300
      - WATCHDOG_CHECK_INTERVAL_S=60
      - WATCHDOG_PAUSE_BEFORE_RESTART_S=120
      - WATCHDOG_MAX_RESTARTS=5
      - WATCHDOG_WINDOW_S=3600
      - WATCHDOG_SERVICE_RECOVERY_ENABLED=${WATCHDOG_SERVICE_RECOVERY_ENABLED:-false}
      - WATCHDOG_SERVICE_RECOVERY_INTERVAL_CHECKS=5
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - WATCHDOG_CONTAINER_PREFIX=hbot-
      - WATCHDOG_STATE_FILE=/tmp/watchdog_state.json
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    networks:
      - trading
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"
