# ============================================
# Hummingbot Trading Infrastructure
# docker-compose.yml - Production Configuration
# ============================================
# Usage:
#   cp ../env/.env.template ../env/.env  # then edit with real values
#   docker compose --env-file ../env/.env -f docker-compose.yml up -d
# ============================================

name: hbot

# ---- Networks ----
networks:
  trading:
    driver: bridge
    name: hbot-trading
  monitoring:
    driver: bridge
    name: hbot-monitoring

# ---- Volumes ----
volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  loki-data:
    driver: local

# ---- Logging anchor ----
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "${LOG_MAX_SIZE:-50m}"
    max-file: "${LOG_MAX_FILE:-5}"

# ---- Hummingbot base anchor ----
x-hbot-base: &hbot-base
  image: ${HUMMINGBOT_IMAGE:-hummingbot/hummingbot:version-2.12.0}
  restart: unless-stopped
  logging: *default-logging
  networks:
    - trading
  environment:
    - TZ=${TZ:-UTC}
  stdin_open: true
  tty: true

# ============================================
# Services
# ============================================
services:

  # ==========================================
  # BOT 1
  # ==========================================
  bot1:
    <<: *hbot-base
    container_name: hbot-bot1
    volumes:
      # ---- Bot config, data, logs ----
      - ../data/bot1/conf:/home/hummingbot/conf
      - ../data/bot1/logs:/home/hummingbot/logs
      - ../data/bot1/data:/home/hummingbot/data
      - ../data/bot1/scripts:/home/hummingbot/custom_scripts
      - ../data/bot1/pmm_scripts:/home/hummingbot/pmm_scripts
      # ---- EPP v2.4 custom controller + helpers ----
      - ../controllers/epp_v2_4.py:/home/hummingbot/controllers/market_making/epp_v2_4.py:ro
      - ../controllers/price_buffer.py:/home/hummingbot/controllers/price_buffer.py:ro
      - ../controllers/ops_guard.py:/home/hummingbot/controllers/ops_guard.py:ro
      - ../controllers/epp_logging.py:/home/hummingbot/controllers/epp_logging.py:ro
      - ../controllers/paper_engine.py:/home/hummingbot/controllers/paper_engine.py:ro
      - ../controllers/fee_resolver.py:/home/hummingbot/controllers/fee_resolver.py:ro
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
    environment:
      - TZ=${TZ:-UTC}
      - CONFIG_PASSWORD=${BOT1_PASSWORD:-}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ==========================================
  # BOT 2 (scale replica)
  # ==========================================
  bot2:
    <<: *hbot-base
    container_name: hbot-bot2
    profiles:
      - multi
    volumes:
      # ---- Bot config, data, logs ----
      - ../data/bot2/conf:/home/hummingbot/conf
      - ../data/bot2/logs:/home/hummingbot/logs
      - ../data/bot2/data:/home/hummingbot/data
      - ../data/bot2/scripts:/home/hummingbot/custom_scripts
      - ../data/bot2/pmm_scripts:/home/hummingbot/pmm_scripts
      # ---- EPP v2.4 custom controller + helpers ----
      - ../controllers/epp_v2_4.py:/home/hummingbot/controllers/market_making/epp_v2_4.py:ro
      - ../controllers/price_buffer.py:/home/hummingbot/controllers/price_buffer.py:ro
      - ../controllers/ops_guard.py:/home/hummingbot/controllers/ops_guard.py:ro
      - ../controllers/epp_logging.py:/home/hummingbot/controllers/epp_logging.py:ro
      - ../controllers/paper_engine.py:/home/hummingbot/controllers/paper_engine.py:ro
      - ../controllers/fee_resolver.py:/home/hummingbot/controllers/fee_resolver.py:ro
      - ../config:/home/hummingbot/project_config:ro
      - ../services:/home/hummingbot/services:ro
    environment:
      - TZ=${TZ:-UTC}
      - CONFIG_PASSWORD=${BOT2_PASSWORD:-admin}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ==========================================
  # BOT 3 (paper trading smoke test)
  # ==========================================
  bot3:
    <<: *hbot-base
    container_name: hbot-bot3
    profiles:
      - test
    volumes:
      - ../data/bot3/conf:/home/hummingbot/conf
      - ../data/bot3/logs:/home/hummingbot/logs
      - ../data/bot3/data:/home/hummingbot/data
      - ../data/bot3/scripts:/home/hummingbot/custom_scripts
      - ../data/bot3/pmm_scripts:/home/hummingbot/pmm_scripts
      # Mount test script into the scripts dir so `start --script` finds it
      - ../data/bot3/scripts/paper_test.py:/home/hummingbot/scripts/paper_test.py:ro
    environment:
      - TZ=${TZ:-UTC}
      - CONFIG_PASSWORD=${BOT3_PASSWORD:-${BOT1_PASSWORD:-}}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"

  # ==========================================
  # External Signal/Risk Stack
  # ==========================================
  redis:
    image: redis:7.2-alpine
    container_name: hbot-redis
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${REDIS_BIND_IP:-127.0.0.1}:${REDIS_PORT:-6379}:6379"
    networks:
      - trading
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  signal-service:
    image: python:3.11-slim
    container_name: hbot-signal-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "pip install --no-cache-dir redis pydantic joblib scikit-learn requests boto3 &&
      PYTHONPATH=/workspace/hbot python /workspace/hbot/services/signal_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - ML_ENABLED=${ML_ENABLED:-false}
      - ML_RUNTIME=${ML_RUNTIME:-sklearn_joblib}
      - ML_MODEL_SOURCE=${ML_MODEL_SOURCE:-local}
      - ML_MODEL_URI=${ML_MODEL_URI:-/workspace/hbot/models/current/model.joblib}
      - ML_MODEL_REFRESH_SEC=${ML_MODEL_REFRESH_SEC:-300}
      - ML_CONFIDENCE_MIN=${ML_CONFIDENCE_MIN:-0.60}
      - ML_MAX_SIGNAL_AGE_MS=${ML_MAX_SIGNAL_AGE_MS:-3000}
      - ML_INFERENCE_TIMEOUT_MS=${ML_INFERENCE_TIMEOUT_MS:-200}
      - ML_HORIZON_S=${ML_HORIZON_S:-60}
      - ML_FEATURE_SET=${ML_FEATURE_SET:-v1}
      - ML_CUSTOM_CLASS_PATH=${ML_CUSTOM_CLASS_PATH:-}
      - ML_S3_HTTP_TIMEOUT_SEC=${ML_S3_HTTP_TIMEOUT_SEC:-10}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=signal_service
    volumes:
      - ..:/workspace/hbot:ro
      - ../models:/workspace/hbot/models:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading

  risk-service:
    image: python:3.11-slim
    container_name: hbot-risk-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "pip install --no-cache-dir redis pydantic &&
      PYTHONPATH=/workspace/hbot python /workspace/hbot/services/risk_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - RISK_MAX_ABS_SIGNAL=${RISK_MAX_ABS_SIGNAL:-0.25}
      - ML_ENABLED=${ML_ENABLED:-false}
      - ML_CONFIDENCE_MIN=${ML_CONFIDENCE_MIN:-0.60}
      - ML_MAX_SIGNAL_AGE_MS=${ML_MAX_SIGNAL_AGE_MS:-3000}
      - RISK_MAX_ABS_PREDICTED_RETURN=${RISK_MAX_ABS_PREDICTED_RETURN:-0.05}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=risk_service
    volumes:
      - ..:/workspace/hbot:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading

  coordination-service:
    image: python:3.11-slim
    container_name: hbot-coordination-service
    profiles:
      - external
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "pip install --no-cache-dir redis pydantic &&
      PYTHONPATH=/workspace/hbot python /workspace/hbot/services/coordination_service/main.py"
    environment:
      - EXT_SIGNAL_RISK_ENABLED=${EXT_SIGNAL_RISK_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-hb_group_v1}
      - EVENT_POLL_MS=${EVENT_POLL_MS:-1000}
      - HB_INSTANCE_NAME=bot1
      - EVENT_PRODUCER_NAME=coordination_service
    volumes:
      - ..:/workspace/hbot:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - trading

  # ==========================================
  # Monitoring Stack
  # ==========================================

  # ---- Bot KPI Exporter ----
  bot-metrics-exporter:
    image: python:3.11-slim
    container_name: hbot-bot-metrics-exporter
    restart: unless-stopped
    logging: *default-logging
    command: >
      /bin/sh -lc "python /workspace/hbot/services/monitoring/bot_metrics_exporter.py"
    environment:
      - PYTHONPATH=/workspace/hbot
      - HB_DATA_ROOT=/workspace/hbot/data
      - METRICS_PORT=9400
      - METRICS_PATH=/metrics
      - EXPORTER_LOG_TAIL_LINES=200
    volumes:
      - ..:/workspace/hbot:ro
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9400/metrics')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ---- Prometheus ----
  prometheus:
    image: prom/prometheus:v2.51.2
    container_name: hbot-prometheus
    restart: unless-stopped
    logging: *default-logging
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}"
      - "--storage.tsdb.retention.size=${PROMETHEUS_RETENTION_SIZE:-5GB}"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    volumes:
      - ../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../monitoring/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9090:9090"
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ---- Grafana ----
  grafana:
    image: grafana/grafana:10.4.2
    container_name: hbot-grafana
    restart: unless-stopped
    logging: *default-logging
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL:-http://localhost:3000}
      - GF_SERVER_SERVE_FROM_SUB_PATH=${GF_SERVER_SERVE_FROM_SUB_PATH:-false}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_LOG_LEVEL=warn
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ../monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:3000:3000"
    networks:
      - monitoring
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ---- Node Exporter ----
  node-exporter:
    image: prom/node-exporter:v1.8.1
    container_name: hbot-node-exporter
    restart: unless-stopped
    logging: *default-logging
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/host/root"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9100:9100"
    networks:
      - monitoring
    pid: host
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # ---- cAdvisor ----
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: hbot-cadvisor
    restart: unless-stopped
    logging: *default-logging
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:8080:8080"
    networks:
      - monitoring
    privileged: true
    devices:
      - /dev/kmsg:/dev/kmsg
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ---- Loki ----
  loki:
    image: grafana/loki:2.9.8
    container_name: hbot-loki
    restart: unless-stopped
    logging: *default-logging
    command: ["-config.file=/etc/loki/loki-config.yml"]
    volumes:
      - ../monitoring/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki-data:/loki
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:3100:3100"
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  # ---- Promtail ----
  promtail:
    image: grafana/promtail:2.9.8
    container_name: hbot-promtail
    restart: unless-stopped
    logging: *default-logging
    command: ["-config.file=/etc/promtail/promtail-config.yml"]
    volumes:
      - ../monitoring/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - ../data:/workspace/hbot/data:ro
    networks:
      - monitoring
    depends_on:
      loki:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  # ---- Alertmanager (optional, activate with profile) ----
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: hbot-alertmanager
    restart: unless-stopped
    logging: *default-logging
    profiles:
      - alerts
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    volumes:
      - ../monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "${MONITORING_BIND_IP:-127.0.0.1}:9093:9093"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"



