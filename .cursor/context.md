# Hummingbot Custom Trading Infrastructure — Project Context

## Project Identity

- **Project**: Dockerized Hummingbot V2 market-making infrastructure with monitoring stack
- **Exchange**: Bitget (spot + perpetual), with config support for Binance/Bybit
- **Hummingbot Version**: V2 (image `hummingbot/hummingbot:version-2.12.0`)
- **Framework**: Hummingbot V2 controller-based architecture (`StrategyV2Base` + `MarketMakingControllerBase`)
- **Deployment**: Docker Compose on Linux VPS (Ubuntu 22/24), developed on Windows 11 with Docker Desktop (WSL2)
- **Root path**: `hbot/` contains all infrastructure; workspace root is the git repo

---

## Architecture

```
hbot/
├── compose/docker-compose.yml          # Orchestration: bot1, bot2, Prometheus, Grafana, node-exporter, cAdvisor
├── controllers/market_making/
│   └── pmm_rsi_llm.py                  # V2 custom controller (RSI + NATR + LLM sentiment)
├── data/bot1/
│   ├── conf/                            # Hummingbot config (bind-mounted → /home/hummingbot/conf)
│   │   ├── controllers/*.yml            # V2 controller YAML configs
│   │   ├── scripts/*.yml                # V2 script YAML configs
│   │   ├── connectors/                  # Encrypted exchange API keys (auto-generated by `connect` command)
│   │   └── strategies/                  # Legacy V1 strategy configs
│   ├── scripts/                         # Hummingbot scripts (bind-mounted → /home/hummingbot/scripts)
│   │   └── v2_with_controllers.py       # Built-in V2 script entry point (copied from image)
│   ├── logs/                            # Runtime logs (errors.log for crash diagnostics)
│   └── data/                            # SQLite databases, trade history
├── scripts/
│   ├── strategies/                      # V1 legacy scripts (pmm_rsi_hedge_llm.py, bitget_spot_mm.py)
│   └── utils/                           # Reusable modules (indicators.py, llm_sentiment.py, health_check.py)
├── monitoring/                          # Prometheus, Grafana, Alertmanager configs
├── env/.env                             # Secrets (gitignored) — API keys, passwords, LLM keys
└── env/.env.template                    # Template for .env
```

---

## Key Technical Decisions

### Docker Bind Mount Behavior (CRITICAL)
Bind-mounting a host directory to a container path **replaces** the container's directory entirely.
This means:
- `data/bot1/conf:/home/hummingbot/conf` wipes the image's built-in conf subdirectories
- `data/bot1/scripts:/home/hummingbot/scripts` wipes the image's built-in scripts
- The local directories MUST contain everything the image originally had
- Required conf subdirectories: `connectors/`, `controllers/`, `scripts/`, `strategies/`
- Built-in scripts must be copied from the image: `docker run --rm -v <local>:/output --entrypoint /bin/bash <image> -c "cp -r /home/hummingbot/scripts/* /output/"`

### Custom Controller Mounting
Custom V2 controllers are mounted as individual files to avoid overriding built-in controllers:
```yaml
- ../controllers/market_making/pmm_rsi_llm.py:/home/hummingbot/controllers/market_making/pmm_rsi_llm.py:ro
```
This adds our file alongside the built-in `pmm_simple.py`, `pmm_dynamic.py`, `dman_maker_v2.py`.

### Password / First Boot
- `CONFIG_PASSWORD` env var auto-logins on boot
- On FIRST RUN, it MUST be empty — there's no `.password_verification` file yet
- User sets password interactively via `docker attach`, which creates `.password_verification`
- After first login, `CONFIG_PASSWORD` can be set for unattended restarts

### Error Logs
- Hummingbot V2 redirects stderr to `./logs/errors.log` (not stdout)
- `docker logs` shows NOTHING — always check `data/bot1/logs/errors.log` for crash diagnostics
- Container CMD: `/bin/bash -lc conda activate hummingbot && ./bin/hummingbot_quickstart.py 2>> ./logs/errors.log`

---

## Hummingbot V2 Framework

### Class Hierarchy
```
ScriptStrategyBase
  └── StrategyV2Base                     # Main script base (v2_with_controllers.py)
        ├── MarketDataProvider            # Candle feeds, price data
        ├── ExecutorOrchestrator          # Manages executors lifecycle
        └── Controllers
              ├── ControllerBase
              │     ├── MarketMakingControllerBase    # Our pmm_rsi_llm extends this
              │     └── DirectionalTradingControllerBase
              └── Executors
                    ├── PositionExecutor   # Triple barrier: TP/SL/time/trailing stop
                    └── OrderExecutor      # Simple order execution
```

### How V2 Controllers Work
1. Controller config is a Pydantic model (`MarketMakingControllerConfigBase` subclass)
2. Controller overrides `update_processed_data()` to set `reference_price` and `spread_multiplier`
3. Base class calls `get_price_and_amount()` which uses: `order_price = reference_price * (1 ± spread * spread_multiplier)`
4. Controller returns `PositionExecutorConfig` from `get_executor_config()`
5. Executors handle order placement, fill tracking, and triple-barrier exits
6. Config YAML in `conf/controllers/` is hot-reloadable (fields with `is_updatable: True`)

### Running a V2 Strategy
```
start --script v2_with_controllers.py --conf <script_config>.yml
```
Script config references controller configs by filename in `conf/controllers/`.

---

## Strategy: PMM + RSI + LLM (`pmm_rsi_llm`)

### Current Design
- **Base**: `MarketMakingControllerBase` with multi-level bid/ask orders
- **Spread sizing**: NATR-based (spreads expressed in NATR units — "1" = 1× current volatility)
- **Reference price shift**: RSI normalizes to [-1,+1], shifts price by `rsi_norm * NATR * factor`
- **LLM overlay**: Optional sentiment score (0-100) shifts price and adjusts spread multiplier
- **Volatility pause**: When NATR exceeds threshold, extreme spread widening
- **Risk**: Built-in triple barrier (TP/SL/time/trailing stop) via PositionExecutor

### Known Issues (from strategy review)
1. **RSI directional bias conflicts with market making** — accumulates inventory in trending markets
2. **Stop-loss (1.5%) is 30-150× larger than per-trade edge** — negative expected value
3. **Executor refresh (300s) is 10× too slow** — quotes become stale
4. **No inventory management** — missing inventory-proportional spread skew
5. **No fee-aware minimum spread** — can place orders below fee threshold
6. **LLM signal is fabricated** — LLMs don't have real-time market data access
7. **Volatility pause is counterproductive** — MM earns most in high vol
8. **Sentiment tightening spreads is backwards** — should widen on directional confidence

### Recommended Parameter Fixes
```yaml
# Production-ready MM parameters:
executor_refresh_time: 30       # not 300
cooldown_time: 5                # not 15
stop_loss: 0.005                # not 0.015
take_profit: 0.005              # not 0.03
time_limit: 900                 # not 7200
leverage: 1                     # not 5 (for spot MM)
llm_enabled: false              # until backtested
```

### Needed Improvements (priority order)
1. Add inventory tracking + inventory-penalized spread skew
2. Add fee-aware minimum spread floor (>= 3× maker fee)
3. Replace RSI price shifting with RSI-based spread widening at extremes
4. Add order book spread awareness (never quote inside the natural spread)
5. Add max inventory limit with emergency flatten
6. Backtest LLM signal before enabling

---

## Strategy Scope: Not Just Market Making

This project supports multiple strategy types via V2 controllers:

### Market Making (`MarketMakingControllerBase`)
- Profit from bid-ask spread, delta-neutral
- Key concern: inventory management, adverse selection, fee-aware spreads
- Built-in controllers: `pmm_simple`, `pmm_dynamic`, `dman_maker_v2`, custom `pmm_rsi_llm`

### Directional Trading (`DirectionalTradingControllerBase`)
- Profit from price prediction (long/short)
- Key concern: signal quality, regime filtering, exit management
- Built-in controllers: see `controllers/directional_trading/`
- `processed_data["signal"]` = -1 (short), 0 (flat), +1 (long)
- Uses `PositionExecutor` with triple barrier for trade lifecycle

### Portfolio Rebalancing (custom, from research)
- Profit from rebalancing premium across correlated assets
- Documented: Sharpe improvement of 0.5-1.0 vs buy-and-hold in crypto
- Daily rebalancing > monthly (more vol capture)
- Long rebalanced + short market-cap = pure alpha extraction
- Risk: transaction costs, outlier assets, regime change
- Reference: `papers/ssrn_id3987908_code4244090.md` (Hanicová & Vojtko, Quantpedia)

### Hybrid Strategies
- MM + directional overlay: Use inventory skew (not price shift) for directional view
- MM + hedge: Spot MM + opposing perp position for delta-neutral
- Directional + rebalancing: Momentum signal picks assets, rebalance captures premium

---

## Exchange Specifics

### Bitget
- Spot connector: `bitget`
- Perpetual connector: `bitget_perpetual`
- **Same API key/secret/passphrase** for both spot and perp
- Credentials entered via `connect bitget` / `connect bitget_perpetual` inside Hummingbot CLI
- Encrypted and stored in `conf/connectors/bitget.yml` / `conf/connectors/bitget_perpetual.yml`
- Maker fee: ~0.02%, Taker fee: ~0.06%
- Paper trade: `bitget_paper_trade` exists but has V2 compatibility bug (`trading_rules` attribute missing)

### Paper Trading Workaround
Paper trade connectors are broken for V2 PositionExecutor. Use real connector with micro capital instead:
```yaml
connector_name: bitget
total_amount_quote: 10   # $10 micro test
```

---

## Monitoring Stack

| Service | Image | Port (localhost only) |
|---------|-------|----------------------|
| Prometheus | `prom/prometheus:v2.51.2` | 9090 |
| Grafana | `grafana/grafana:10.4.2` | 3000 |
| Node Exporter | `prom/node-exporter:v1.8.1` | 9100 |
| cAdvisor | `gcr.io/cadvisor/cadvisor:v0.49.1` | 8080 |
| Alertmanager | `prom/alertmanager:v0.27.0` | 9093 (profile: alerts) |

Access via SSH tunnel: `ssh -L 3000:127.0.0.1:3000 user@vps`

---

## Common Operations

```bash
# Start bot1 + monitoring
cd hbot/compose
docker compose --env-file ../env/.env up -d

# Attach to bot
docker attach hbot-bot1
# Detach: Ctrl+P, Ctrl+Q

# Check crash logs (NOT docker logs!)
cat hbot/data/bot1/logs/errors.log

# Start V2 strategy
>>> start --script v2_with_controllers.py --conf v2_pmm_paper.yml

# Restart after config change
docker compose --env-file ../env/.env up -d bot1
```

---

## File Sensitivity

| Path | Contains secrets? | Git tracked? |
|------|-------------------|-------------|
| `env/.env` | YES — API keys, passwords | NO (gitignored) |
| `data/*/conf/connectors/` | YES — encrypted exchange keys | NO |
| `env/.env.template` | No — placeholders only | YES |
| `controllers/**/*.py` | No | YES |
| `data/*/scripts/*.py` | No — copied from image | NO (gitignored) |
| `data/*/conf/controllers/*.yml` | Possibly LLM keys | Partial |
